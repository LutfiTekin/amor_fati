<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Ribbon of Fate Tied Across the Earth</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        html, body { margin: 0; padding: 0; height: 100%; }
        #map { width: 100%; height: 100%; }
        .leaflet-popup-content-wrapper {
          background: linear-gradient(#fdf1c7, #e8d0a9);
          border: 2px solid #c2a66b;
          border-radius: 8px;
        }
        .leaflet-popup-tip {
          background: linear-gradient(#fdf1c7, #e8d0a9);
        }
        .flip-card {
          width: 120px; height: 180px; perspective: 1000px; cursor: pointer; flex-shrink: 0;
        }
        .flip-card-inner {
          position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.6s;
        }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back {
          position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
        }
        .flip-card-back { transform: rotateY(180deg); }
        .flip-card-front img, .flip-card-back img {
          width: 100%; height: 100%; object-fit: cover; border-radius: 4px; display: block;
        }
        .popup-container { display: flex; align-items: flex-start; }
        .popup-text { margin-left: 12px; text-align: left; }
        .popup-text strong { display: block; margin-bottom: 4px; }
        .popup-text em { display: block; margin-bottom: 6px; font-style: italic; }
        .popup-text ul { padding-left: 18px; margin: 0; }
    </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    (async function() {
      const params = new URLSearchParams(window.location.search);
      const cardParam = params.get('cards');
      if (!cardParam) {
        alert("No cards specified.");
        return;
      }
      const cardCodes = cardParam.split('-').map(c => c.toUpperCase()).slice(0, 5);
      const [loreData, coordinates] = await Promise.all([
        fetch('lore.json').then(r => r.json()),
        fetch('coordinates.json').then(r => r.json())
      ]);
      const map = L.map('map').setView([20, 0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const lore = {};
      for (const c of loreData.cards) lore[c.code] = c;

      const points = [];
      for (const code of cardCodes) {
        const coord = coordinates[code];
        const card = lore[code];
        if (!coord || !card) continue;
        points.push([coord.lat, coord.lng]);
        const codeLower = code.toLowerCase();
        const popup = `
          <div class="popup-container">
            <div class="flip-card flipped">
              <div class="flip-card-inner">
                <div class="flip-card-front">
                  <img src="${codeLower}.png" alt="${code}"/>
                </div>
                <div class="flip-card-back">
                  <img src="${codeLower}_back.png" onerror="this.onerror=null;this.src='back.png'"/>
                </div>
              </div>
            </div>
            <div class="popup-text">
              <strong>${code.replace(/_/g, ' ')}</strong>
              <em>${card.story}</em>
              <ul>${(card.effects || []).map(e => `<li>${e}</li>`).join('')}</ul>
            </div>
          </div>`;
        const icon = L.icon({ iconUrl: `thumbnails/${codeLower}.png`, iconSize:[50,75], iconAnchor:[25,75] });
        const marker = L.marker([coord.lat, coord.lng], { icon }).addTo(map);
        marker.bindPopup(popup);
        marker.on('popupopen', () => {
          const el = marker.getPopup().getElement();
          const fc = el.querySelector('.flip-card');
          setTimeout(() => fc.classList.remove('flipped'), 2000);
          fc.addEventListener('click', () => fc.classList.toggle('flipped'));
        });
      }
      if (points.length > 1) {
        L.polyline(points, { color: 'purple', weight: 4, opacity: 0.8 }).addTo(map);
        map.fitBounds(points);
      }
    })();
</script>
</body>
</html>